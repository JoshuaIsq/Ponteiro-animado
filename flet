import math
import time
import flet as ft
# --- ESTADO DO SISTEMA ---


def main(page: ft.Page):

    # ------ 1 CONFIGURAÇÃO DA PAGINA 
    page.title = "Velocimetro da senoide"
    page.theme_mode = page.theme_mode = ft.ThemeMode.DARK
    page.vertical_alignment = ft.MainAxisAlignment.CENTER
    page.horizontal_alignment = ft.CrossAxisAlignment.CENTER


    # ------ 2 VARIAVEIS DE ESTADO
    speed = 0.1 
    last_speed = 0.1 # Para lembrar a velocidade quando despausar
    fase = 0

    # --- COMPONENTE 1: O VELOCÍMETRO (GAUGE) ---
    
    # O Ponteiro é um retângulo vermelho fino
    # O segredo é o 'transform_origin': definimos que ele gira pela base (bottom)
    ponteiro = ft.Container(
        width=8,
        height=70,
        bgcolor=ft.Colors.RED_ACCENT,
        border_radius=4,
        # Começa apontando para baixo (-3.14 rads seria topo, ajustaremos no loop)
        rotate=ft.Rotate(0, alignment=ft.alignment.bottom_center),
        animate_rotation=ft.Animation(300, ft.AnimationCurve.EASE_OUT),
        offset=ft.Offset(0, -0.5) # Ajuste fino para o pino ficar no centro
    )

    # O Mostrador é um círculo cinza
    mostrador = ft.Container(
        width=150,
        height=150,
        bgcolor=ft.Colors.BLUE_GREY_900,
        border_radius=75, # Metade da largura = Círculo perfeito
        border=ft.border.all(4, ft.Colors.WHITE24),
        alignment=ft.alignment.center,
        content=ft.Stack(
            controls=[
                # Pino central (uma bolinha pequena para esconder a base do ponteiro)
                ft.Container(width=10, height=10, bgcolor=ft.Colors.WHITE, border_radius=5),
                ponteiro, # O ponteiro fica por cima
            ],
            alignment=ft.alignment.center
        )
    )
# --- COMPONENTE 2: O GRÁFICO (SENOIDE) ---
    
    # Criamos 50 pontos iniciais zerados
    dados_grafico = [ft.LineChartDataPoint(i, 0) for i in range(50)]
    
    grafico = ft.LineChart(
        data_series=[
            ft.LineChartData(
                data_points=dados_grafico,
                color=ft.Colors.CYAN,
                stroke_width=3,
                curved=True,
                below_line_bgcolor=ft.Colors.with_opacity(0.1, ft.Colors.CYAN) # Área sombreada
            )
        ],
        min_y=-1.5, max_y=1.5, min_x=0, max_x=50,
        height=200, # Altura fixa para o gráfico
        expand=True
    )

    # Texto digital
    texto_velocidade = ft.Text(value="0.0 Hz", size=30, weight="bold", color="white")

    # Montando o Layout
    layout = ft.Column(
        controls=[
            ft.Text("TESTE FLET", size=12, color="grey"),
            mostrador,          # O Velocímetro
            texto_velocidade,   # O Texto Digital
            ft.Container(grafico, padding=20), # A Senoide
            ft.Text("Espaço: Pause | Setas: Acelerar/Frear", color="grey", size=10)
        ],
        horizontal_alignment=ft.CrossAxisAlignment.CENTER,
        spacing=20
    )
    page.add(layout)


    # ---- 3 controle
    def on_keyboard(e: ft.KeyboardEvent): 
        nonlocal speed, last_speed
        if e.key == " ":
            if speed != 0:
                last_speed = speed
                speed = 0
            elif speed == 0:
                speed == last_speed


        elif e.key == "Arrow Up":
            speed += 0.2
            if speed > 1: speed = 1
    
        elif e.key == "Arrow Down":
            speed -= 0.2
            if speed < 0: speed = 0

    page.on_keyboard_event = on_keyboard

  # --- LOOP DE ANIMAÇÃO ---
    while True:
        # 1. Atualizar Física da Onda
        if speed > 0:
            fase += speed
            # Recalcula a onda inteira com a nova fase
            for i, p in enumerate(dados_grafico):
                # i*0.2 define o comprimento da onda visível na tela
                p.y = math.sin((i * 0.2) + fase)

        # 2. Atualizar Ponteiro (Velocímetro)
        # Matemática: Convertendo 0..1 (speed) para Angulo (Radianos)
        # -2.2 rad é esquerda (0%), 2.2 rad é direita (100%)
        angulo_maximo = 2.2 
        ponteiro.rotate.angle = (speed * 2 * angulo_maximo) - angulo_maximo
        
        # 3. Atualizar Texto
        texto_velocidade.value = f"{speed:.2f} Hz"
        
        page.update()
        time.sleep(0.03)

ft.app(target=main)



























